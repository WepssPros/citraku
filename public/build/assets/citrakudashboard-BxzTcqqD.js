const E="https://lightblue-capybara-113853.hostingersite.com/geopasial-map/api/kelurahan",T="https://lightblue-capybara-113853.hostingersite.com/geopasial-map/api/rt";var s=L.map("jambi-map").setView([-1.6,103.6],15),f={"Google Street":L.tileLayer("https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),"Google Satellite":L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),"Google Hybrid":L.tileLayer("https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"]}),OpenStreetMap:L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"Â© OpenStreetMap"})};const k=[],p=[];let v=!1;window.addEventListener("keydown",function(o){o.ctrlKey&&(v=!0)});window.addEventListener("keyup",function(o){o.key==="Control"&&(v=!1)});s.scrollWheelZoom.disable();s.getContainer().addEventListener("wheel",function(o){v&&(o.preventDefault(),o.deltaY<0?s.zoomIn():s.zoomOut())});f.OpenStreetMap.addTo(s);var K=L.control({position:"topright"});K.onAdd=function(o){var e=L.DomUtil.create("div","leaflet-control-layers");for(var n in f){var l="https://upload.wikimedia.org/wikipedia/commons/f/f6/Street_View_logo.png",t=L.DomUtil.create("label");t.innerHTML=`<img src="${l}" width="30" height="30" title="${n}" style="cursor:pointer;">`,t.onclick=function(a){return function(){o.eachLayer(function(i){i instanceof L.TileLayer&&o.removeLayer(i)}),f[a].addTo(o)}}(n),e.appendChild(t)}return e};K.addTo(s);fetch(T).then(o=>o.json()).then(o=>{if(o.forEach(e=>{const n=e.nomor,l=e.id,t=e.color;try{const a=JSON.parse(e.koordinat);if(a&&a.coordinates&&a.coordinates.length>0){let i=[];a.type==="Polygon"?i.push(a.coordinates[0].map(c=>({lat:c[1],lng:c[0]}))):a.type==="MultiPolygon"&&a.coordinates.forEach(c=>{i.push(c[0].map(d=>({lat:d[1],lng:d[0]})))}),i.length>0?x(n,i,l,t):console.warn(`No valid coordinates for RT: ${n}`)}else console.warn(`No coordinates found for RT: ${n}`)}catch(a){console.error(`Error parsing GeoJSON for RT ${n}:`,a)}}),k.length>0){const e=L.latLngBounds();k.forEach(n=>{e.extend(n.getBounds())}),s.fitBounds(e)}else console.warn("No RT polygons available to fit bounds")}).catch(o=>{console.error("Error fetching RT data:",o)});function x(o,e,n,l){const t=L.polygon(e,{color:l||"blue",fillOpacity:.5}).addTo(s);t.on("mouseover",function(){s.getZoom()<15&&t.setStyle({color:l||"blue",fillOpacity:.6,weight:3})}),t.on("mouseout",function(){s.getZoom()<15&&t.setStyle({color:l||"blue",fillOpacity:.5,weight:1})}),t.on("click",function(){s.fitBounds(t.getBounds()),$("#rtModal"+n).modal("show")}),t.bindPopup(` ${o}`),k.push(t)}fetch(E).then(o=>o.json()).then(o=>{o.forEach(n=>{const l=n.nama,t=n.id,a=n.color,i=n.marker,d=JSON.parse(n.koordinat).coordinates[0].map(r=>({lat:r[1],lng:r[0]}));O(l,d,t,a,i)});var e=L.latLngBounds();p.forEach(function(n){e.extend(n.getBounds())}),s.fitBounds(e)}).catch(o=>{console.error("Error fetching kelurahan data:",o)});function O(o,e,n,l,t){const a=l?l.trim():"green",i=L.polygon(e.map(r=>[r.lat,r.lng]),{color:a,weight:2,opacity:.65,fillOpacity:.3,interactive:!0}).addTo(s);i.bringToFront();const c=L.polyline(e.map(r=>[r.lat,r.lng]),{color:"white",weight:1,opacity:1}).addTo(s),d=i.getBounds().getCenter();if(t===1){const r=L.icon({iconUrl:"../frontend/img/logocitraku.png",iconSize:[25,25],iconAnchor:[12.5,25],popupAnchor:[0,-25]}),u=L.marker([d.lat,d.lng],{icon:r}).addTo(s);u.bindTooltip(o,{permanent:!1,direction:"top",className:"kelurahan-tooltip"}),u.on("click",function(){s.fitBounds(i.getBounds()),$("#kelurahanModal"+n).modal("show")})}i.on("mouseover",function(){s.getZoom()<15&&(c.setStyle({color:"blue"}),i.setStyle({color:a,fillOpacity:.5}))}),i.on("mouseout",function(){s.getZoom()<15&&(c.setStyle({color:"white"}),i.setStyle({color:a,fillOpacity:.3}))}),i.on("click",function(){s.fitBounds(i.getBounds()),$("#kelurahanModal"+n).modal("show")}),p.push(i)}const P="http://citraku.test/api/kumuh",h=[];fetch(P).then(o=>o.json()).then(o=>{if(o.forEach(e=>{const n=e.nama,l=e.id,t=e.color,a=JSON.parse(e.koordinat);if(a&&a.coordinates&&a.coordinates.length>0){let i=[];a.type==="Polygon"?i.push(a.coordinates[0].map(c=>({lat:c[1],lng:c[0]}))):a.type==="MultiPolygon"&&a.coordinates.forEach(c=>{i.push(c[0].map(d=>({lat:d[1],lng:d[0]})))}),i.length>0?C(n,i,l,t):console.warn(`No valid coordinates for Kawasan: ${n}`)}else console.warn(`No coordinates found for Kawasan: ${n}`)}),h.length>0){const e=L.latLngBounds();h.forEach(n=>{e.extend(n.getBounds())}),s.fitBounds(e)}else console.warn("No Kawasan Kumuh polygons available to fit bounds")}).catch(o=>{console.error("Error fetching Kawasan Kumuh data:",o)});function C(o,e,n,l){const t=L.polygon(e,{color:l||"yellow",fillOpacity:.5}).addTo(s);t.on("mouseover",function(){t.setStyle({color:l||"yellow",fillOpacity:.6,weight:3})}),t.on("mouseout",function(){t.setStyle({color:l||"yellow",fillOpacity:.5,weight:1})}),t.on("click",function(){s.fitBounds(t.getBounds()),$("#rtModal"+n).modal("show")}),t.bindPopup(` ${o}`),h.push(t)}const M=L.Control.extend({options:{position:"topright"},onAdd:function(o){const e=L.DomUtil.create("div","custom-control");return e.innerHTML=`
            <div class="layer-control-card">
                <div class="layer-control-header" id="jenisPetaHeader">
                    <p>Jenis Peta</p>
                    <span class="toggle-icon">+</span>
                </div>
                <div class="layer-control-body" id="jenisPetaBody" style="display: none;">
                    <label>
                        <input type="checkbox" id="toggleKecamatan" checked>
                        <span>Batas Administrasi Kecamatan</span>
                    </label>
                    <label>
                        <input type="checkbox" id="toggleKelurahan" checked>
                        <span>Batas Administrasi Kelurahan</span>
                    </label>
                </div>
            </div>

            <div class="layer-control-card">
                <div class="layer-control-header" id="petaTematikHeader">
                    <p>Peta Tematik</p>
                    <span class="toggle-icon">+</span>
                </div>
                <div class="layer-control-body" id="petaTematikBody" style="display: none;">
                    <label>
                        <input type="checkbox" id="toggleKawasanKumuh">
                        <span>Kawasan Kumuh</span>
                    </label>
                </div>
            </div>
        `,L.DomEvent.disableClickPropagation(e),e.querySelector("#toggleKawasanKumuh").addEventListener("change",n=>{n.target.checked?h.forEach(t=>{o.addLayer(t)}):h.forEach(t=>{o.removeLayer(t)})}),e.querySelector("#toggleKelurahan").addEventListener("change",n=>{n.target.checked?p.forEach(t=>{o.addLayer(t)}):p.forEach(t=>{o.removeLayer(t)})}),e.querySelector("#toggleKecamatan").addEventListener("change",n=>{n.target.checked?kecPolygons.forEach(t=>{o.addLayer(t)}):kecPolygons.forEach(t=>{o.removeLayer(t)})}),e}});s.addControl(new M);document.getElementById("jenisPetaHeader").addEventListener("click",function(){const o=document.getElementById("jenisPetaBody"),e=this.querySelector(".toggle-icon");o.style.display==="none"?(o.style.display="block",e.textContent="-"):(o.style.display="none",e.textContent="+")});document.getElementById("petaTematikHeader").addEventListener("click",function(){const o=document.getElementById("petaTematikBody"),e=this.querySelector(".toggle-icon");o.style.display==="none"?(o.style.display="block",e.textContent="-"):(o.style.display="none",e.textContent="+")});const j=L.Control.extend({options:{position:"topright"},onAdd:function(o){const e=L.DomUtil.create("div","custom-control");return e.innerHTML=`
            <div class="layer-control-card">
                <div class="layer-control-header" id="kelurahanHeader">
                    <p>Pilih Kawasan</p>
                    <span class="toggle-icon">+</span> <!-- Ikon toggle -->
                </div>
                <div class="layer-control-body" id="kelurahanBody" style="display: none; max-height: 300px; overflow-y: auto;">
               
                </div>
            </div>

        `,L.DomEvent.disableClickPropagation(e),fetch(E).then(n=>n.json()).then(n=>{n.forEach(l=>{const t=l.id,a=l.nama,i=l.color,d=JSON.parse(l.koordinat).coordinates[0].map(g=>({lat:g[1],lng:g[0]})),r=i?i.trim():"green",u=L.polygon(d.map(g=>[g.lat,g.lng]),{color:r,weight:2,opacity:.65,fillOpacity:.3,interactive:!0}).addTo(o),b=L.polyline(d.map(g=>[g.lat,g.lng]),{color:"white",weight:1,opacity:1}).addTo(o);u.on("mouseover",function(){o.getZoom()<15&&(b.setStyle({color:"blue"}),u.setStyle({color:r,fillOpacity:.5}))}),u.on("mouseout",function(){o.getZoom()<15&&(b.setStyle({color:"white"}),u.setStyle({color:r,fillOpacity:.3}))}),u.on("click",function(){o.fitBounds(u.getBounds()),$("#kelurahanModal"+t).modal("show")}),u.kelurahanId=t,p.push(u);const m=document.createElement("label");m.innerHTML=`
                        <input type="checkbox" class="toggleKelurahan" data-id="${t}">
                        <span>${a}</span>
                    `,e.querySelector("#kelurahanBody").appendChild(m),m.querySelector(".toggleKelurahan").addEventListener("change",g=>{const w=g.target.getAttribute("data-id"),B=g.target.checked,y=p.find(S=>S.kelurahanId&&S.kelurahanId.toString()===w);if(!y){console.error(`Polygon tidak ditemukan untuk ID: ${w}`),console.log("Isi kelurahanPolygons:",p);return}B?(o.addLayer(y),y.setStyle({color:"blue",fillOpacity:.5})):(o.removeLayer(y),y.setStyle({color:r,weight:2,opacity:.65,fillOpacity:.5}))})})}),e}});s.addControl(new j);function I(o,e){const n=document.getElementById(o),l=document.getElementById(e),t=n.querySelector(".toggle-icon");n.addEventListener("click",()=>{const a=l.style.display==="block";l.style.display=a?"none":"block",t.textContent=a?"+":"-"})}I("kelurahanHeader","kelurahanBody");
